# Gestione di un club sportivo

L'applicativo Python realizzato, sia in REST che GraphQL, simula la gestione delle prenotazioni dei servizi di un club sportivo. È composto precisamente da due microservizi che comunicano sincronicamente tra di loro:  

- *member-service* per la gestione dei soci del club, solo loro possono usufruire delle risorse, è possibile effettuare nuove iscrizioni. Se un membro si disiscrive dal club allora tutte le sue prenotazioni da quel giorno in poi non saranno più valide.  
Gira sulle porte 5000:5000.

- *resource-service* per la gestione delle prenotazioni delle risorse, come i campi da calcio, tennis e beach volley per un limite di un'ora al giorno per tipologia dalle 10 alle 21, in più c'è anche la possibilità di prenotare lettini e/o ombrelloni nella piscina del club durante il periodo estivo (dal 20 maggio al 15 settembre di ogni anno). La struttura dispone di un totale di 20 ombrelloni e 80 lettini.   
Gira sulle porte 5001:5000.

Per la memorizzazione dei dati viene utilizzato SQLite e il file *.db* di ogni microservizio è salvato come volume all'interno dei container, non visibile in locale.

## REST

### *member-service*

Aggiunta di un membro
```bash
curl -X POST "http://localhost:5000/members" -H "Content-Type: application/json" -d "{"cf":"RSSMRA85M01H501Z", "name":"Mario", "surname":"Rossi"}"
```

Eliminazione di un membro e automatica cancellazione di tutte le sue prenotazioni
```bash
curl -X DELETE http://localhost:5000/members/RSSMRA85M01H501Z
```

Verifica dell'esistenza di un membro
```bash
curl -X GET http://localhost:5000/members/RSSMRA85M01H501Z
```

Elenco di tutti i membri
```bash
curl -X GET http://localhost:5000/members
```

### *resource-service*

Aggiunta di una prenotazione di un campo
```bash
curl -X POST "http://localhost:5001/resources/campo" -H "Content-Type: application/json" -d "{"cf":"RSSMRA85M01H501Z", "data":"2025-09-20", "ora":"10", "tipologia":"tennis"}"
```

Aggiunta di una prenotazione in piscina
```bash
curl -X POST "http://localhost:5001/resources/piscina" -H "Content-Type: application/json" -d "{"cf": "RSSMRA85M01H501Z", "data":"2025-09-11", "lettini":2, "ombrelloni":1}"
```

Eliminazione di una prenotazione di un campo
```bash
curl -X DELETE "http://localhost:5001/resources/campo" -H "Content-Type: application/json" -d "{"cf":"RSSMRA85M01H501Z", "data":"2025-09-20", "ora":"10", "tipologia":"tennis"}"
```

Eliminazione di una prenotazione in piscina
```bash
curl -X DELETE "http://localhost:5001/resources/piscina" -H "Content-Type: application/json" -d "{"cf": "RSSMRA85M01H501Z", "data":"2025-09-11", "lettini":2, "ombrelloni":1}"
```

Visualizzazione degli slot liberi di un campo in una data precisa
```bash
curl -X GET http://localhost:5001/resources/campiliberi/2025-08-20/tennis
```

Visualizzazione di ombrelloni e lettini liberi in una data precisa
```bash
curl -X GET "http://localhost:5001/resources/piscinalibera/2025-09-11"
```

## GRAPHQL con strawberry

STRAWBERRY libreria Python che permette di costruire API GraphQL

TIPO struttura dati utilizzata nella comunicazione client-server  

```python
@strawberry.type
class MemberType:
    cf: str
    name: str
    surname: str
    registration_date: date
```

```@strawberry.input``` è un tipo specifico quando vengono forniti dati in input ad una mutazione

```python
@strawberry.input
class MemberInput:
    cf: str
    name: str
    surname: str
```

QUERY richieste del client per recuperare dati dal server

```graphql
query {
  checkMember(cf: "MRTLRA01D70F257N") {
    name
    surname
  }
}
```
In questo esempio si sta invocando la query collegata alla funzione ```checkMember``` che richiede l'argomento ```cf```, vengono specificati i campi di output desiderati, non è obbligatorio inserirli tutti (```cf```, ```name```, ```surname```, ```registration_date```), ma solo quelli a cui si è interessati.

Risposta
```graphql
{
  "data": {
    "checkMember": {
      "name": "Lara",
      "surname": "Martino"
    }
  }
}
```

MUTAZIONI richieste del client per modificare e creare dati sul server

```graphql
mutation {
  addMember(member: {
    cf: "RSSMRA85M01H501U",
    name: "Mario",
    surname: "Rossi"
  })
}
```
In questo esempio si sta invocando la mutazione collegata alla funzione ```addMember``` che richiede il tipo input  ```member``` con tutti i suoi campi obbligatori.

Risposta
```graphql
{
  "data": {
    "addMember": "Member added"
  }
}
```

In caso di errore, ad esempio il membro esiste già
```graphql
{
  "data": null,
  "errors": [
    {
      "message": "Member already exists",
      "locations": [
      {
          "line": 2,
          "column": 3
        }
      ],
      "path": [
        "addMember"
      ]
    }
  ]
}
```

SCHEMA definizione di tipi, query e mutazioni per la comunicazione tra client e server.

# Altre strutture 

ALIAS utilizzati per fare più richieste all'interno di una singola query. È utile quando si desidera recuperare dati simili ma differenziarli nella risposta.  
Attenzione! Se una qualsiasi parte della query non viene eseguita correttamente, l'intera query genererà un errore.

```graphql
query {
  alias1: checkMember (cf: "MRTLRA01D70F257N"){
    name
    surname
    
  }
  
  alias2: checkMember (cf: "RSSMRA85M01H501U"){
    name
    surname
    
  }
}
```

Risposta
```graphql
{
  "data": {
    "alias1": {
      "name": "Lara",
      "surname": "Martino"
    },
    "alias2": {
      "name": "Mario",
      "surname": "Rossi"
    }
  }
}
```

FRAMMENTI unità di campi riutilizzabili, consentono di definire un set di campi che è possibile includere in più query, mutazioni o altri frammenti.

```graphql
fragment memberData on MemberType {
  name
  surname
}

query {
  alias1: checkMember (cf: "MRTLRA01D70F257N"){
    ...memberData
    
  }
  
  alias2: checkMember (cf: "RSSMRA85M01H501U"){
    ...memberData
    
  }
}
```

VARIABILI permettono di parametrizzare query e mutazioni rendendole dinamiche e riutilizzabili al client
```graphql
query ($cf:String!){
  checkMember (cf: $cf ){
    name
  surname
    
  }
}
```
Nella sezione ```Variabili``` dell'interfaccia bisogna inserire ```{"cf": "MRTLRA01D70F257N"}```

DIRETTIVE per includere o escludere in modo condizionale campi o frammenti di una query in base a determinate condizioni. Utili se si vuole personalizzare la risposta in base ai requisiti del cliente.
```graphql
query GetMember($withRegistrationDate: Boolean!) {
  checkMember(cf: "MRTLRA01D70F257N") {
    name
    surname
    registrationDate @include(if: $withRegistrationDate)
  }
}
```
Nella sezione ```Variabili``` dell'interfaccia bisogna inserire ```{"withRegistrationDate": false}``` o ```{"withRegistrationDate": true}```, il campo ```registrationDate``` verrà restituito solo se la variabile correlata è ```true```.

QUERY DI INTROSPEZIONE query speciale che consente di interrogare lo schema di un server GraphQL per esplorare le funzionalità di un'API.  
*GraphiQL* utilizza questa query in anticipo suggerendo al client campi disponibili, tipi di ritorno, campi opzionali o obbligati, e al tempo stesso, sa sempre che dati riceverà e l'IDE avvisa se si sta chiedendo qualcosa di sbagliato, generando meno bug.


### *member-service*

Richieste all'interfaccia grafica interattiva GraphiQL ```http://localhost:5000/graphql```

Aggiunta di un membro
```graphql
mutation {
  addMember(member: {
    cf: "RSSMRA85M01H501U",
    name: "Mario",
    surname: "Rossi"
  })
}
```

Eliminazione di un membro e automatica cancellazione di tutte le sue prenotazioni
```graphql
mutation {
  deleteMember(cf: "RSSMRA85M01H501U")
}
```

Verifica dell'esistenza di un membro
```graphql
query {
  checkMember(cf: "RSSMRA85M01H501U") {
    cf
    name
    surname
    registrationDate
  }
}
```

Elenco di tutti i membri
```graphql
query {			
  allMembers {
    cf
    name
    surname
    registrationDate 
  }
}
```

### *resource-service*

Richieste all'interfaccia grafica interattiva GraphiQL ```http://localhost:5001/graphql```

Aggiunta di una prenotazione di un campo
```graphql
mutation {
  addCampo(booking: {
    cf: "RSSMRA85M01H501U"
    data: "2025-09-20"
    ora: 15
    tipologia: calcio
  }) {
    detail
  }
}
```

Aggiunta di una prenotazione in piscina
```graphql
mutation {
  addPiscina(booking: {
    cf: "RSSMRA85M01H501U"
    data: "2025-09-11"
    lettini: 4
    ombrelloni: 2
  }) {
    detail
  }
}
```

Eliminazione di una prenotazione di un campo
```graphql
mutation {
  deleteCampo(booking: {
    cf: "RSSMRA85M01H501U"
    data: "2025-09-20"
    ora: 15
    tipologia: calcio
  }) {
    detail
  }
}
```

Eliminazione di una prenotazione in piscina
```graphql
mutation {
  deletePiscina(booking: {
    cf: "RSSMRA85M01H501U"
    data: "2025-09-11"
    lettini: 4
    ombrelloni: 2
  }) {
    detail
  }
}
```

Visualizzazione degli slot liberi di un campo in una data precisa
```graphql
query {
  getCampiliberi(data: "2025-08-20", tipologia: tennis) {
    ora
  }
}
```

Visualizzazione di ombrelloni e lettini liberi in una data precisa
```graphql
query {
  getPiscinalibera(data: "2025-09-11") {
    lettiniLiberi
    ombrelloniLiberi
  }
}
```
